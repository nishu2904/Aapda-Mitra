
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rescuer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{margin:0;font-family:Arial;background:#f4f6f8}
    header{background:#111827;color:#fff;padding:16px 20px}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);cursor:pointer}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800}
    .btn{padding:10px 12px;border:0;border-radius:10px;cursor:pointer;font-weight:800;margin-right:8px}
    .primary{background:#00e676}
    .warn{background:#ffd600}
    .ghost{background:#e5e7eb}
    .muted{color:#6b7280;font-size:13px}
    .hidden{display:none}
    iframe{width:100%;height:320px;border:0;border-radius:12px;margin-top:12px}
    video{width:100%;border-radius:12px;margin-top:12px}
  </style>
</head>
<body>
<header>
  <div style="max-width:980px;margin:0 auto;font-weight:900;">Aapda Mitra — Rescuer Dashboard</div>
</header>

<div class="wrap">
  <button id="myLocBtn" class="btn ghost">Use My Location</button>
  <div id="status" class="muted"></div>

  <h3>Alerts</h3>
  <div id="list" class="grid"></div>

  <div id="detail" class="hidden">
    <h3>Alert Detail</h3>
    <div class="card" id="detailCard"></div>

    <div style="margin-top:10px">
      <a id="dir" target="_blank" class="btn primary">Directions</a>
      <a id="safe" target="_blank" class="btn warn">Safest Route</a>
      <button id="accept" class="btn warn">Accept</button>
      <button id="resolve" class="btn primary">Resolve</button>
    </div>

    <iframe id="map"></iframe>
    <div id="media"></div>
  </div>
</div>

<script>
const API_BASE="http://127.0.0.1:8000";
let myLoc=null;
let selected=null;

async function getJSON(u){
  const r=await fetch(u);
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

async function postJSON(u,b){
  const r=await fetch(u,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(b)
  });
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

document.getElementById("myLocBtn").onclick=()=>{
  document.getElementById("status").textContent="Getting rescuer location...";
  if(!navigator.geolocation){
    document.getElementById("status").textContent="Geolocation not supported";
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    myLoc={lat:pos.coords.latitude,lng:pos.coords.longitude};
    document.getElementById("status").textContent=`Rescuer loc: ${myLoc.lat.toFixed(4)}, ${myLoc.lng.toFixed(4)}`;
    if(selected) openDetail(selected);
  },()=>{document.getElementById("status").textContent="Location denied";},{enableHighAccuracy:true,timeout:8000});
};

function sevBg(sev){
  if(sev==="CRITICAL") return "#fca5a5";
  if(sev==="MEDIUM") return "#fde68a";
  return "#bbf7d0";
}

function renderList(items){
  const list=document.getElementById("list");
  list.innerHTML="";
  items.forEach(a=>{
    const people = (a.people ?? 1);
    const status = (a.status ?? "NEW");
    const sev = (a.severity ?? "UNKNOWN");

    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">Persons: ${people}</div>
          <div class="muted">Severity: ${sev} • Status: ${status}</div>
          <div class="muted">${a.timestamp ? new Date(a.timestamp).toLocaleString() : "-"}</div>
          <div class="muted">(${a.latitude}, ${a.longitude})</div>
        </div>
        <span class="pill" style="background:${sevBg(sev)}"> ${sev}</span>
      </div>`;
    c.onclick=()=>openDetail(a);
    list.appendChild(c);
  });
}

function openDetail(a){
  selected=a;
  document.getElementById("detail").classList.remove("hidden");

  const people = (a.people ?? 1);
  const status = (a.status ?? "NEW");
  const sev = (a.severity ?? "UNKNOWN");

  document.getElementById("detailCard").innerHTML=`
    <div style="font-weight:900">SOS ID: ${a.user_id}</div>
    <div class="muted">Persons: ${people}</div>
    <div class="muted">Severity: ${sev} • Status: ${status}</div>
    <div class="muted">Note: ${a.note || "-"}</div>
    <div class="muted">Loc: ${a.latitude}, ${a.longitude}</div>
  `;

  const lat=a.latitude, lng=a.longitude;
  document.getElementById("map").src=`https://www.google.com/maps?q=${lat},${lng}&output=embed`;

  const dir = myLoc
    ? `https://www.google.com/maps/dir/?api=1&origin=${myLoc.lat},${myLoc.lng}&destination=${lat},${lng}`
    : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

  document.getElementById("dir").href=dir;
  document.getElementById("safe").href=dir + "&avoid=tolls|highways";

  document.getElementById("accept").onclick = async () => {
    try{
      await postJSON(`${API_BASE}/accept_sos`, { user_id: a.user_id });
      alert("Accepted ✅");
      await refresh();
    }catch(e){
      alert("Accept failed ❌\n" + e.message);
    }
  };

  document.getElementById("resolve").onclick = async () => {
    try{
      await postJSON(`${API_BASE}/resolve_sos`, { user_id: a.user_id });
      alert("Resolved ✅");
      await refresh();
    }catch(e){
      alert("Resolve failed ❌\n" + e.message);
    }
  };

  const mediaDiv=document.getElementById("media");
  mediaDiv.innerHTML="";

  const media = (a.media || []);
  const vids = media.filter(m => m && m.type === "video");

  if(vids.length === 0){
    mediaDiv.innerHTML = `<div class="muted" style="margin-top:10px">No video uploaded yet.</div>`;
    return;
  }

  vids.forEach(m=>{
    const v=document.createElement("video");
    v.controls=true;
    v.src = API_BASE + (m.url || ("/media/" + m.filename));
    mediaDiv.appendChild(v);
  });
}

async function refresh(){
  try{
    const data=await getJSON(`${API_BASE}/get_active_sos`);
    const items = data.active_sos || [];
    renderList(items);

    if(selected){
      const fresh = items.find(x=>x.user_id===selected.user_id);
      if(fresh) openDetail(fresh);
    }
  }catch(e){}
}

refresh();
setInterval(refresh,3000);
</script>
</body>
</html>
